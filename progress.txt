## Codebase Patterns
- Git worktree at /Users/christian/git/dasch/dsp-api/ingest-bagit-export — use `git -C <path>` for git commands
- BagIt module tests: `./sbtx 'bagit/test'` — runs from the worktree root
- ExtractionLimits.scala uses `Long` for byte limits with `L` suffix multiplication expressions
- All sbt commands run from the worktree root directory
- Ingest project definition in build.sbt (lines 386-466) uses `import Dependencies._` — members available without prefix
- Ingest compilation: `./sbtx 'ingest/compile'` (~41s)
- Ingest formatting: `./sbtx 'ingest/scalafmt'` to auto-format, `./sbtx 'ingest/scalafmtCheck'` to verify
- BagIt imports: `org.knora.bagit.BagIt`, `org.knora.bagit.domain.{BagInfo, PayloadEntry, Bag}`
- `ProjectFolder.path` gives the underlying `zio.nio.file.Path`; `ProjectShortcode.value` gives the string
- BagIt error imports: `org.knora.bagit.BagItError` — sealed trait with `.message: String` on all variants
- `BagIt.readAndValidateZip(zipPath)` returns `ZIO[Scope, IOException | BagItError, (Bag, Path)]` — payload under bagRoot/data/
- `FileUtils.moveDirectory(src, dest)` renames src to dest when dest doesn't exist (same filesystem)
- In tests, `Body.fromFile` returns `ZIO[Any, Nothing, Body]` — needs `<-` not `=` in for-comprehensions
- Test files: `zio.nio.file.Path` vs `zio.http.Path` ambiguity — use fully qualified `zio.nio.file.Path.fromJava`
- ImportFailed sealed trait in ImportService.scala has 3 variants: IoError, BagItValidationFailed, ProjectAlreadyExists — adding/removing requires updating endpoint handler match (fatal warnings)
- `Files.isDirectory` returns `UIO[Boolean]` (infallible) — don't use `.mapError` on it
- `AugmentedPath → Path` implicit conversion requires both `import swiss.dasch.domain.AugmentedPath.Conversions.given_Conversion_AugmentedPath_Path` AND `import scala.language.implicitConversions`
- `Files.walk(path).filterZIO(p => Files.isRegularFile(p)).runHead.map(_.isDefined)` — pattern for checking if directory has files
- `FileUtils.moveDirectory(src, dest)` requires dest to NOT exist — delete empty dirs first
- ZIO tuple destructuring `(a, b) <- effect` in for-comprehensions won't compile — use `result <- effect` then `val a = result._1`
- BagIt manifest `entry.path.value` includes `data/` prefix — paths are relative to bag root, not data dir
- `ChecksumAlgorithm.computeDigest(is)` returns `Task[String]` — don't close stream before effect runs; use Java MessageDigest directly for blocking
- ImportService test layers: AssetInfoServiceLive, FileChecksumServiceLive, ImportServiceLive, ProjectService, ProjectRepositoryLive, StorageServiceLive, SpecConfigurations.storageConfigLayer, TestUtils.testDbLayerWithEmptyDb
- Don't import unused `AugmentedPath.Conversions` or `scala.language.implicitConversions` in test files — fatal unused import warnings

---

## 2026-02-24 - US-001
- Updated default extraction limits in ExtractionLimits.scala
- maxSingleEntryBytes: 5 GB → 20 GB (20L * 1024 * 1024 * 1024)
- maxTotalBytes: 10 GB → 200 GB (200L * 1024 * 1024 * 1024)
- Files changed: modules/bagit/src/main/scala/org/knora/bagit/ExtractionLimits.scala
- **Learnings for future iterations:**
  - All 107 BagIt tests pass after the change — tests don't depend on specific limit values
  - The worktree is on branch `ralph/ingest-bagit-export` created from main
  - sbt compilation takes ~17s including test run
---

## 2026-02-24 - US-002
- Added `.dependsOn(bagit)` to the ingest project definition in build.sbt (line 390)
- Follows same pattern as webapi (line 175) which already depends on bagit
- Files changed: build.sbt
- **Learnings for future iterations:**
  - The ingest project is defined at lines 386-466 in build.sbt inside a `lazy val ingest = { ... }` block
  - `sbt 'ingest/compile'` takes ~41s (longer than bagit-only compilation)
  - The ingest project uses `import Dependencies._` at the top of its block, so Dependencies members are available without prefix
---

## 2026-02-24 - US-003
- Replaced `zipProjectPath` method (which used `ZipUtility.zipFolder`) with `exportProjectAsBagIt` method using `BagIt.create`
- BagIt export includes: Source-Organization, External-Identifier (shortcode), Ingest-Export-Version: 1 in bag-info.txt
- Uses `PayloadEntry.Directory(prefix = "", sourcePath = projectPath.path)` to include project folder contents under data/
- SHA-512 manifest generated by default, Payload-Oxum and Bagging-Date are auto-computed by BagCreator
- Output zip written to `storage.getTempFolder() / "zipped"` (same directory strategy as before)
- Files changed: ingest/src/main/scala/swiss/dasch/domain/ProjectService.scala
- **Learnings for future iterations:**
  - `ProjectFolder` has a `.path` field to access the underlying `zio.nio.file.Path`
  - `ProjectShortcode` has a `.value` method to get the string representation
  - BagIt imports: `org.knora.bagit.BagIt`, `org.knora.bagit.domain.{BagInfo, PayloadEntry}`
  - The `zipProject` method name and signature were kept unchanged for backward compatibility with callers
  - `Files.createDirectories(path).whenZIO(Files.notExists(path))` is the ZIO pattern for mkdir -p
  - All 153 ingest tests pass with the BagIt export — existing test for "zipping a project" validates it returns a file path
  - `sbt 'ingest/scalafmt'` to auto-format; `sbt 'ingest/scalafmtCheck'` to verify formatting
---

## 2026-02-24 - US-004
- Changed Content-Disposition filename from `export-$shortcode.zip` to `export-$shortcode.bagit.zip` in postExportEndpoint
- Content-Type remains `application/zip`, response body still streams via `ZStream.fromFile`
- Files changed: ingest/src/main/scala/swiss/dasch/api/ProjectsEndpointsHandler.scala
- **Learnings for future iterations:**
  - The export endpoint is `postExportEndpoint` at line 208 of ProjectsEndpointsHandler.scala
  - The import endpoint is `getImportEndpoint` at line 226 — handles IoError, EmptyFile, NoZipFile, InvalidChecksums error variants
  - Content-Disposition filename is a simple string interpolation in the `.mapBoth` success branch
---

## 2026-02-24 - US-005
- Rewrote ImportServiceLive to use `BagIt.readAndValidateZip` instead of manual zip check + unzip + checksum verification
- Added `BagItValidationFailed(message: String)` error variant to ImportFailed sealed trait
- Removed old validation methods: `validateZipFile`, `checkIsNotEmptyFile`, `checkIsZipFile`, `unzipAndVerifyChecksums`
- Import flow: save stream → BagIt.readAndValidateZip (validates structure, checksums) → move data/ to project folder
- Updated endpoint handler to map BagItValidationFailed to 400 Bad Request
- Updated export test to expect `.bagit.zip` filename (from US-004)
- Updated import test to create a valid BagIt zip via `BagIt.create` instead of using old static test-import.zip
- Files changed: ingest/src/main/scala/swiss/dasch/domain/ImportService.scala, ingest/src/main/scala/swiss/dasch/api/ProjectsEndpointsHandler.scala, ingest/src/test/scala/swiss/dasch/api/ProjectsEndpointSpec.scala
- **Learnings for future iterations:**
  - `BagIt.readAndValidateZip` requires `Scope` — use inside `ZIO.scoped` block
  - Union type error `IOException | BagItError` can be pattern matched with `case e: IOException` / `case e: BagItError`
  - The old test-import.zip is no longer valid for import tests — must create BagIt zips programmatically
  - `PayloadEntry.Directory(prefix = "fg", sourcePath = sourceDir)` puts files under `data/fg/` in the bag
  - `Body.fromFile(path.toFile)` returns a ZIO effect, not a Body directly — use `<-` in for-comprehensions
  - `zio.nio.file.Path` vs `zio.http.Path` ambiguity in test files — use fully qualified path when both are imported
  - Constructor params `assetService` and `assetInfos` are kept in ImportServiceLive but unused — US-010 will clean up
---

## 2026-02-24 - US-006
- Added `ProjectAlreadyExists(shortcode: ProjectShortcode)` error variant to ImportFailed sealed trait
- Rewrote `importProject` to check if project folder exists and has files before importing
- If folder exists with files → fails with `ProjectAlreadyExists` error
- If folder exists but is empty → deletes it (so `moveDirectory` works) and proceeds
- If folder doesn't exist → proceeds normally
- Removed `projectService.deleteProject(shortcode)` call from import flow (safety change)
- Mapped `ProjectAlreadyExists` to 409 Conflict in endpoint handler with message: "Project {shortcode} already exists. Delete the project before importing."
- Files changed: ingest/src/main/scala/swiss/dasch/domain/ImportService.scala, ingest/src/main/scala/swiss/dasch/api/ProjectsEndpointsHandler.scala
- **Learnings for future iterations:**
  - `Files.isDirectory` returns `UIO[Boolean]` — cannot use `.mapError` on it (ZIO CanFail constraint)
  - `AugmentedPath` to `Path` implicit conversion needs BOTH the given import AND `scala.language.implicitConversions`
  - `ZIO.when(cond)(ZIO.fail(error))` is the idiomatic pattern for conditional failure in ZIO
  - `Files.walk(path)` without maxDepth traverses all subdirectories
  - `Files.deleteRecursive(path)` deletes the directory and all contents — available from `zio.nio.file.Files`
  - The import endpoint handler's error match must be exhaustive — adding a new ImportFailed variant requires adding a case
---

## 2026-02-24 - US-007
- Removed old unreachable ImportFailed error variants: `EmptyFile`, `NoZipFile`, `InvalidChecksums`
- Removed corresponding match cases from import endpoint handler in ProjectsEndpointsHandler
- Verified 409 Conflict already supported in Tapir endpoint via `BaseEndpoints.defaultErrorOutputs` (includes `StatusCode.Conflict`)
- `ProjectAlreadyExists` → 409 and `BagItValidationFailed` → 400 mappings were already in place from US-005/US-006
- Files changed: ingest/src/main/scala/swiss/dasch/domain/ImportService.scala, ingest/src/main/scala/swiss/dasch/api/ProjectsEndpointsHandler.scala
- **Learnings for future iterations:**
  - `BaseEndpoints.defaultErrorOutputs` already includes all common HTTP error codes (400, 401, 403, 404, 409, 500, 503) — no per-endpoint Tapir changes needed for standard error responses
  - ImportFailed now has only 3 variants: `IoError`, `BagItValidationFailed`, `ProjectAlreadyExists`
  - Removing sealed trait variants is safe as long as no code produces them and no tests reference them — compiler enforces exhaustive matching
---

## 2026-02-24 - US-008
- Added 7 unit tests for BagIt export in ProjectServiceSpec.scala
- Tests verify: BagIt validation passes, payload files match directory structure, bag-info.txt metadata (Source-Organization, External-Identifier, Ingest-Export-Version), Payload-Oxum correctness, SHA-512 checksum integrity
- Files changed: ingest/src/test/scala/swiss/dasch/domain/ProjectServiceSpec.scala
- **Learnings for future iterations:**
  - ZIO tuple destructuring in for-comprehensions (`(a, b) <- effect`) requires `withFilter` which ZIO doesn't have — use `result <- effect` then `val a = result._1` pattern instead
  - `ChecksumAlgorithm.computeDigest(is)` returns `Task[String]` (ZIO effect) — don't wrap in try/finally that closes the stream before effect runs. Use Java's `MessageDigest` directly for blocking checksum computation.
  - BagIt manifest `entry.path.value` already includes `data/` prefix (paths are relative to bag root), so use `bagRoot / entry.path.value` NOT `bagRoot / "data" / entry.path.value`
  - All 14 ProjectServiceSpec tests pass (7 existing + 7 new BagIt export tests)
---

## 2026-02-24 - US-009
- Added 5 unit tests for BagIt import and conflict detection in new ImportServiceSpec.scala
- Tests: ProjectAlreadyExists when project has files, corrupted checksum validation failure, missing manifest validation failure, round-trip file structure restoration, round-trip checksum integrity
- Used Java ZipFile/ZipOutputStream to create corrupted and structurally invalid BagIt zips for negative testing
- Tests use `@@ TestAspect.sequential` to ensure round-trip tests that modify filesystem run in order
- Files changed: ingest/src/test/scala/swiss/dasch/domain/ImportServiceSpec.scala
- **Learnings for future iterations:**
  - To test corrupted BagIt zips: read valid zip with `ZipFile`, copy entries with `ZipOutputStream`, flip bytes in `data/` payload files
  - To test missing manifest: create zip with just `bagit.txt` and `data/` entries, no `manifest-*.txt`
  - ImportService tests need layers: AssetInfoServiceLive, FileChecksumServiceLive, ImportServiceLive, ProjectService, ProjectRepositoryLive, StorageServiceLive, StorageConfig, TestDb
  - `nonExistentProject` ("0042") is safe for negative import tests since no folder exists for it
  - `existingProject` ("0001") has real files — good for round-trip and conflict detection tests
  - Don't import `AugmentedPath.Conversions` or `scala.language.implicitConversions` in test files that use `ProjectFolder.path` directly — compiler warns about unused imports (fatal)
  - All 165 ingest tests pass (5 new ImportService + 160 existing)
---

## 2026-02-24 - US-010
- Deleted `ZipUtility.scala` entirely (both `ZipUtility` and `ScopedIoStreams` objects)
- Inlined `ScopedIoStreams.fileInputStream` into `FileChecksumService.createSha256Hash` (the only external caller)
- Deleted `ZipUtilitySpec.scala` (2 tests for removed zip/unzip functionality)
- Removed unused constructor params from `ImportServiceLive`: `assetService`, `assetInfos`, `projectService` (remnants of old ZIP import handling)
- Old ImportFailed variants (EmptyFile, NoZipFile, InvalidChecksums) were already removed in US-007
- No unused imports remain; formatting check passes
- Files changed: ingest/src/main/scala/swiss/dasch/domain/ZipUtility.scala (deleted), ingest/src/test/scala/swiss/dasch/domain/ZipUtilitySpec.scala (deleted), ingest/src/main/scala/swiss/dasch/domain/FileChecksumService.scala, ingest/src/main/scala/swiss/dasch/domain/ImportService.scala
- **Learnings for future iterations:**
  - `ZLayer.derive` auto-wires based on constructor params — removing unused params simplifies the dependency graph without breaking tests that provide extra layers
  - 163 tests pass after cleanup (2 fewer than before — the removed ZipUtilitySpec tests)
  - Inlining a single-method utility into its only caller is cleaner than keeping an orphaned utility object
---
