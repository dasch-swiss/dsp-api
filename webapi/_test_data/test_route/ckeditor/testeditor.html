<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>A Simple Page with CKEditor to test standoff creation</title>
    <script src="http://cdn.ckeditor.com/4.6.1/full/ckeditor.js"></script>
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    <script type="text/javascript">
        'use strict';

        $(document).ready(function () {

            var createStandoff = function () {

                // create the default mapping in Knora
                var fd = new FormData();

                var params = {
                    resource_id: "http://data.knora.org/a-thing",
                    property_id: "http://www.knora.org/ontology/anything#hasText",
                    project_id: "http://data.knora.org/projects/anything",
                    mapping_id: "http://data.knora.org/projects/anything/mappings/StandardMapping" // put the IRI of the mapping to be used here after running createMapping.sh
                };

                var content = CKEDITOR.instances.editor1.getData();

                var xml = '<?xml version="1.0" encoding="UTF-8"?><text documentType="ckeditor">\n' + content + "</text>"

                console.log(xml);

                fd.append('json', JSON.stringify(params));
                fd.append('xml', xml);

                function make_base_auth(user, password) {
                    var tok = "anything-user" + ':' + "test";
                    var hash = btoa(tok);
                    return 'Basic ' + hash;
                }


                var readTextValue = function (id) {

                    $.get('http://localhost:3333/v1/standoff/' + encodeURIComponent(id), function (data) {
                        console.log("result: ");
                        console.log(data.xml);
                    }, 'json');

                };

                $.ajax({
                    url: "http://localhost:3333/v1/standoff",
                    data: fd,
                    cache: false,
                    processData: false,
                    contentType: false,
                    type: 'POST',
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader('Authorization', make_base_auth('anything-user', 'test'));
                    },
                    success: function (data, status, req) {

                        console.log(data);


                        readTextValue(data.id);


                    },
                    error: function (req, status, error) {
                        console.log(req.responseJSON);
                    }
                });


            };

            // specify allowed elements, attributes, and classes
            // this must conform to the mapping to be used
            var filter = ' p em strong strike u sub sup; a[!href](salsah-link)';

            var config = {
                //extraPlugins: 'footnotes',
                language: 'en', // customize language
                allowedContent: filter,
                pasteFilter: filter,
                on: {
                    instanceReady: function (event) {

                        event.editor.setData('<p>This is a very stupid test</p>');

                    }
                },
                //mathJaxLib : '//cdn.mathjax.org/mathjax/2.6-latest/MathJax.js?config=TeX-AMS_HTML',
                //toolbar: [[ 'Source' ], [ 'footnotes' ]]
                /*toolbar: [
                 ['Source', '-', 'NewPage', 'Preview', '-', 'Templates'],
                 ['Cut', 'Copy', 'Paste', 'PasteText', 'PasteFromWord', '-', 'Undo', 'Redo'],
                 '/', ['Bold', 'Italic', 'Underline', 'Strike', 'Subscript', 'Superscript', '-', 'RemoveFormat', 'Link', 'Unlink']
                 ]*/
                // configuration for toolbar buttons
                toolbar: [
                    ['Source', 'Bold', 'Italic', 'Underline', 'Strike', 'Subscript', 'Superscript', '-', 'RemoveFormat', 'Link', 'Unlink']
                ]
            };

            // Replace the <textarea id="editor1"> with a CKEditor
            // instance, using default configuration.
            CKEDITOR.replace('editor1', config);


            var button = $("<button>").text("Send").on("click", function () {


                createStandoff();

            }).appendTo($("div"));

        });
    </script>
</head>

<body>
<div>
        <textarea name="editor1" id="editor1" rows="10" cols="80">
                This is my textarea to be replaced with CKEditor.
            </textarea>
</div>
</body>

</html>
