# Ralph Progress Log
Started: Mon Feb  2 09:56:52 CET 2026
---

## 2026-02-02 10:00 - US-001
- What was implemented: Created InternalFilename value class
- Files changed: webapi/src/main/scala/org/knora/webapi/slice/admin/domain/model/InternalFilename.scala
- **Learnings for future iterations:**
  - Value classes extend StringValue from org.knora.webapi.slice.common.Value.StringValue
  - Companion objects should extend StringValueCompanion[T]
  - Pattern: use Either[String, T] for from() validation
  - Use private constructor and expose factory via companion object
---

## 2026-02-02 10:02 - US-002
- What was implemented: Created GetFileValueQuery builder object
- Files changed: webapi/src/main/scala/org/knora/webapi/slice/admin/repo/GetFileValueQuery.scala
- **Learnings for future iterations:**
  - For complex CONSTRUCT queries with property paths, use string interpolation approach
  - Use zeroOrMore() helper for property path patterns like previousValue*
  - KnoraBase vocabulary constants are in org.knora.webapi.slice.common.repo.rdf.Vocabulary.KnoraBase
  - Use variable().getQueryString to get SPARQL representation of variables
  - Construct case class accepts raw SPARQL string
---

## 2026-02-02 10:04 - US-003
- What was implemented: Unit tests for GetFileValueQuery
- Files changed: webapi/src/test/scala/org/knora/webapi/slice/admin/repo/GetFileValueQuerySpec.scala
- **Learnings for future iterations:**
  - ZIOSpecDefault is the base class for zio-test specs
  - Use unsafeFrom() to create value classes in tests
  - Compare entire SPARQL string using stripMargin for readability
  - Run tests with: sbt 'testOnly *QuerySpec*'
---

## 2026-02-02 10:07 - US-004
- What was implemented: Updated AssetPermissionsResponder to use GetFileValueQuery
- Files changed: webapi/src/main/scala/org/knora/webapi/responders/admin/AssetPermissionsResponder.scala
- **Learnings for future iterations:**
  - Remove unused imports (Construct, sparql) after switching to query builder
  - Convert string to InternalFilename using ZIO.fromEither with mapError for proper error handling
  - triplestoreService.query() accepts the Construct directly from builder
---

## 2026-02-02 10:08 - US-005
- What was implemented: Removed deprecated Twirl template
- Files changed: Deleted webapi/src/main/twirl/org/knora/webapi/messages/twirl/queries/sparql/admin/getFileValue.scala.txt
- **Learnings for future iterations:**
  - Use grep to verify no other code references the template before deletion
  - References like "getFileValueContent" in other files are method names, not template references
---

## 2026-02-13 14:38 - US-002 through US-010 (BagIt)
- What was implemented: Complete BagIt RFC 8493 library with error model, checksum algorithms, domain types, path security, manifest parser/writer, bag-info parser/writer, bag creator, bag reader, bag validator, and public API facade
- Files changed:
  - modules/bagit/src/main/scala/org/knora/bagit/BagIt.scala (public API facade)
  - modules/bagit/src/main/scala/org/knora/bagit/BagItError.scala (error hierarchy)
  - modules/bagit/src/main/scala/org/knora/bagit/ChecksumAlgorithm.scala (SHA-256/512)
  - modules/bagit/src/main/scala/org/knora/bagit/domain/ (PayloadPath, PayloadEntry, Manifest, BagInfo, Bag)
  - modules/bagit/src/main/scala/org/knora/bagit/internal/ (PathSecurity, ManifestParser, ManifestWriter, BagInfoParser, BagInfoWriter, BagCreator, BagReader, BagValidator)
  - modules/bagit/src/test/scala/org/knora/bagit/ (ChecksumAlgorithmSpec, BagItSpec)
  - modules/bagit/src/test/scala/org/knora/bagit/domain/ (PayloadPathSpec)
  - modules/bagit/src/test/scala/org/knora/bagit/internal/ (PathSecuritySpec, ManifestParserSpec, BagCreatorSpec, BagReaderSpec, BagValidatorSpec)
- **Learnings for future iterations:**
  - Strict `-Wunused:all -Xfatal-warnings` scalac options require removing all unused imports
  - Opaque types need extension methods for value access
  - ZIO.scoped for temp directory cleanup in tests
  - java.security.MessageDigest for checksum computation in streaming fashion
  - Use java.util.zip.ZipOutputStream/ZipInputStream for bag ZIP I/O
  - 42 tests total: all pass in ~300ms
---

## 2026-02-13 14:20 - US-001 (BagIt)
- What was implemented: Set up bagit sbt module with directory structure, dependencies, and build config
- Files changed: build.sbt, project/Dependencies.scala, modules/bagit/src/main/scala/org/knora/bagit/BagIt.scala (placeholder)
- **Learnings for future iterations:**
  - Follow testkit pattern for new module: buildSettings, customScalacOptions, HeaderPlugin, publish/skip := true
  - Add bagitDependencies (zio, zio-streams, zio-nio) and bagitTestDependencies (zio-test, zio-test-sbt) to Dependencies.scala
  - Update root aggregation, headerCreateAll, and headerCheckAll aliases when adding new modules
  - Use `./sbtx bagit/compile` to verify module setup
---

## 2026-02-02 10:11 - US-006
- What was implemented: Verified tests
- Status: Unit tests pass (171 tests). Integration tests require Docker (testcontainers).
- **Manual verification required:**
  - Run `./sbtx 'test-it/testOnly org.knora.webapi.responders.admin.AssetPermissionsResponderSpec'` with Docker Desktop running
- **Learnings for future iterations:**
  - Integration tests in test-it module require Docker Desktop
  - Unit tests in webapi module can run without Docker
  - Query behavior verification should be done via integration tests with real triplestore
---

## 2026-02-13 16:30 - US-011
- What was implemented: Changed default checksum algorithm from SHA-256 to SHA-512 per RFC 8493 Section 3 recommendation
- Files changed:
  - modules/bagit/src/main/scala/org/knora/bagit/BagIt.scala (default parameter changed)
  - modules/bagit/src/test/scala/org/knora/bagit/BagItSpec.scala (two new tests + listZipEntryNames helper)
- **Learnings for future iterations:**
  - Use `_` wildcard for unused tuple destructuring elements to avoid `-Wunused:all` compile errors
  - To inspect ZIP contents in tests, use ZipInputStream to iterate entry names without extracting
  - 44 tests pass in ~283ms
---

## 2026-02-13 17:35 - US-012
- What was implemented: Added MD5 and SHA-1 support to ChecksumAlgorithm for reading legacy bags
- Files changed:
  - modules/bagit/src/main/scala/org/knora/bagit/ChecksumAlgorithm.scala (added MD5/SHA1 enum cases + fromBagitName parsing)
  - modules/bagit/src/test/scala/org/knora/bagit/ChecksumAlgorithmSpec.scala (added MD5/SHA1 digest and parsing tests)
  - modules/bagit/src/test/scala/org/knora/bagit/BagItSpec.scala (added legacy MD5 bag round-trip test)
- **Learnings for future iterations:**
  - BagReader/BagValidator work generically with any ChecksumAlgorithm — just adding enum cases is enough for read support
  - To test reading legacy algorithm bags, manually construct a ZIP with the manifest (e.g. manifest-md5.txt) using java.security.MessageDigest + ZipOutputStream
  - Don't import classes in test files that are only used in the production code — strict `-Wunused:all` will reject them
  - 52 tests pass in ~321ms
---

## 2026-02-13 18:40 - US-013
- What was implemented: Percent-encoding for special characters in manifest paths per RFC 8493 Section 2.1.3
- Files changed:
  - modules/bagit/src/main/scala/org/knora/bagit/internal/ManifestPathEncoding.scala (new - encode/decode for LF, CR, %)
  - modules/bagit/src/main/scala/org/knora/bagit/internal/ManifestWriter.scala (encode paths on write)
  - modules/bagit/src/main/scala/org/knora/bagit/internal/ManifestParser.scala (decode paths on read)
  - modules/bagit/src/main/scala/org/knora/bagit/internal/BagCreator.scala (encode paths in manifest generation)
  - modules/bagit/src/test/scala/org/knora/bagit/internal/ManifestPathEncodingSpec.scala (new - 11 tests)
  - modules/bagit/src/test/scala/org/knora/bagit/internal/ManifestParserSpec.scala (3 new decode tests)
  - modules/bagit/src/test/scala/org/knora/bagit/BagItSpec.scala (1 new round-trip test with % in filename)
- **Learnings for future iterations:**
  - ManifestPathEncoding only encodes LF, CR, and % per RFC 8493 — not the full RFC 3986 character set
  - Decode BEFORE PayloadPath validation so traversal attacks via percent-encoding (e.g. %2E%2E) are caught
  - BagCreator writes manifest lines directly via string interpolation, not ManifestWriter — both need encoding
  - PayloadPath already allows % without changes since it only blocks .., /, ~, \, drive letters, and null bytes
  - 66 tests pass in ~384ms
---

## 2026-02-13 19:45 - US-014
- What was implemented: Tag manifest completeness validation — BagValidator.checkTagManifests now reports ManifestEntryMissing when a tag file listed in a tag manifest does not exist on disk
- Files changed:
  - modules/bagit/src/main/scala/org/knora/bagit/internal/BagValidator.scala (line 102: ZIO.succeed(None) → ZIO.succeed(Some(ManifestEntryMissing(path))))
  - modules/bagit/src/test/scala/org/knora/bagit/internal/BagValidatorSpec.scala (3 new tests: deleted bag-info.txt, deleted manifest file, tampered tag file)
- **Learnings for future iterations:**
  - Tag manifest entries reference files at bag root level (bagit.txt, bag-info.txt, manifest-*.txt) — not under data/
  - createAndReadBag helper in BagValidatorSpec creates a bag with SHA256 + BagInfo, producing tag manifests that cover bagit.txt, bag-info.txt, and manifest-sha256.txt
  - 69 tests pass in ~396ms
---

## 2026-02-13 20:47 - US-015
- What was implemented: Strict bagit.txt parsing — BagReader.parseBagitTxt now enforces exactly two non-empty lines in correct order with exact string matching, tolerates LF and CRLF line endings, and properly closes the Source
- Files changed:
  - modules/bagit/src/main/scala/org/knora/bagit/internal/BagReader.scala (parseBagitTxt rewritten for strict parsing + resource leak fix)
  - modules/bagit/src/test/scala/org/knora/bagit/internal/BagReaderSpec.scala (6 new tests: version 1.0.1 rejected, reversed lines rejected, extra third line rejected, version 0.97 rejected, CRLF accepted, valid two-line accepted)
- **Learnings for future iterations:**
  - Use `split("\n", -1)` with `stripSuffix("\r")` to handle both LF and CRLF line endings, then filter empty lines
  - For strict text file parsing, use exact string equality (`!=`) instead of `contains()`/`find()` to prevent substring matches
  - Always wrap `scala.io.Source.fromFile` in try/finally to close the Source — prevents resource leaks
  - 75 tests pass in ~336ms
---

## 2026-02-13 21:52 - US-016
- What was implemented: Changed BagInfo.additionalFields from Map[String, String] to List[(String, String)] to preserve ordering and allow duplicate keys per RFC 8493 Section 2.2.2
- Files changed:
  - modules/bagit/src/main/scala/org/knora/bagit/domain/BagInfo.scala (additionalFields type changed)
  - modules/bagit/src/main/scala/org/knora/bagit/internal/BagInfoParser.scala (removed reservedFields guard, use List.newBuilder, first occurrence to dedicated field, subsequent to additionalFields)
  - modules/bagit/src/main/scala/org/knora/bagit/internal/BagInfoWriter.scala (write in insertion order, not sorted)
  - modules/bagit/src/test/scala/org/knora/bagit/internal/BagInfoParserSpec.scala (new - 4 tests: duplicate Contact-Name, ordering, repeated dedicated field, round-trip)
  - modules/bagit/src/test/scala/org/knora/bagit/internal/BagInfoWriterSpec.scala (new - 2 tests: duplicate labels, insertion order)
- **Learnings for future iterations:**
  - BagCreator doesn't need changes when switching additionalFields from Map to List — it passes BagInfo through to BagInfoWriter opaquely
  - Use `if someOption.isEmpty` guard on match cases to direct first occurrence to dedicated Option field and subsequent to additionalFields
  - BagInfoWriter previously sorted additionalFields by key — removed sorting to preserve insertion order per RFC
  - 81 tests pass in ~376ms
---

## 2026-02-13 22:55 - US-017
- What was implemented: Added tests verifying all RFC-defined reserved fields (Contact-Name, Bag-Group-Identifier, Bag-Count, Organization-Address, Bag-Size, Contact-Phone, Contact-Email, Internal-Sender-Identifier, Internal-Sender-Description) are preserved in additionalFields. Also added a comprehensive round-trip test with all reserved fields.
- Files changed:
  - modules/bagit/src/test/scala/org/knora/bagit/internal/BagInfoParserSpec.scala (6 new tests)
- **Learnings for future iterations:**
  - The reservedFields guard was already removed in US-016 — the `case _ =>` branch in BagInfoParser already routes all non-dedicated fields to additionalFields
  - No production code changes needed for this story, only tests to verify the behavior
  - 87 tests pass in ~386ms
---

## 2026-02-13 23:55 - US-018
- What was implemented: Fixed resource leaks in BagReader (parseManifests, parseBagInfo) and BagValidator (checkChecksums, checkTagManifests) by properly closing file handles
- Files changed:
  - modules/bagit/src/main/scala/org/knora/bagit/ChecksumAlgorithm.scala (computeDigest now closes InputStream via try/finally)
  - modules/bagit/src/main/scala/org/knora/bagit/internal/BagReader.scala (parseManifests and parseBagInfo wrap Source in try/finally)
  - modules/bagit/src/test/scala/org/knora/bagit/internal/BagReaderSpec.scala (new test: temp dir cleanup after read)
  - modules/bagit/src/test/scala/org/knora/bagit/internal/BagValidatorSpec.scala (new test: 60-file bag validation without fd leak)
- **Learnings for future iterations:**
  - Fix resource leaks at the consumer (ChecksumAlgorithm.computeDigest) rather than at every call site — closes the InputStream for both checkChecksums and checkTagManifests in one place
  - ZIO.scoped temp directory cleanup proves no locked handles: after scope exits, the temp dir no longer exists
  - parseBagitTxt was already fixed in US-015 — only parseManifests and parseBagInfo needed the try/finally treatment
  - 89 tests pass in ~560ms
---

## 2026-02-13 17:32 - US-019
- What was implemented: Guarded against null from java.io.File.listFiles() in all three walkFiles/walkDirectory methods
- Files changed:
  - modules/bagit/src/main/scala/org/knora/bagit/internal/BagReader.scala (walkFiles: null guard)
  - modules/bagit/src/main/scala/org/knora/bagit/internal/BagCreator.scala (walkDirectory: null guard)
  - modules/bagit/src/main/scala/org/knora/bagit/internal/BagValidator.scala (walkFiles: null guard)
- **Learnings for future iterations:**
  - Pattern for null-safe listFiles: `Option(dir.listFiles()).map(_.toList).getOrElse(Nil)`
  - java.io.File.listFiles() returns null when the path is not a directory or an I/O error occurs
  - All three walkFiles/walkDirectory methods had identical structure — same fix applied to each
  - 89 tests pass in ~646ms
---

## 2026-02-13 17:35 - US-020
- What was implemented: Added 3 tests proving null from listFiles() is handled gracefully (no NPE)
- Files changed:
  - modules/bagit/src/test/scala/org/knora/bagit/internal/BagReaderSpec.scala (1 new test: data/ as regular file → MissingPayloadDirectory)
  - modules/bagit/src/test/scala/org/knora/bagit/internal/BagCreatorSpec.scala (1 new test: PayloadEntry.Directory to non-existent dir → empty bag, no NPE)
  - modules/bagit/src/test/scala/org/knora/bagit/internal/BagValidatorSpec.scala (1 new test: data/ replaced by file → MissingPayloadDirectory)
- **Learnings for future iterations:**
  - To test walkFiles null guard in BagReader, create a zip with "data" as a file entry (not directory) — zip extraction creates a file, not a dir
  - BagCreator.walkDirectory on non-existent path returns Nil (not error), so createBag succeeds with zero payload files
  - BagValidator.checkStructural catches MissingPayloadDirectory when data/ exists but is not a directory
  - Use Files.deleteRecursive to remove a directory before replacing it with a file in tests
  - 92 tests pass in ~601ms
---

## 2026-02-13 17:39 - US-021
- What was implemented: Fixed FileInputStream resource leaks in BagValidator.checkChecksums and checkTagManifests by opening streams inside ZIO.scoped with ZIO.fromAutoCloseable(ZIO.attemptBlocking(new FileInputStream(file))), and simplified ChecksumAlgorithm.computeDigest to no longer manage stream lifecycle itself
- Files changed:
  - modules/bagit/src/main/scala/org/knora/bagit/ChecksumAlgorithm.scala (computeDigest simplified: removed ZIO.scoped/fromAutoCloseable wrapper, caller now manages stream lifecycle)
  - modules/bagit/src/main/scala/org/knora/bagit/internal/BagValidator.scala (checkChecksums and checkTagManifests: FileInputStream opened inside ZIO effect with proper resource management)
- **Learnings for future iterations:**
  - When fixing resource leaks, move stream creation inside ZIO effects — `new FileInputStream(file)` in argument position is a side-effect
  - Use ZIO.scoped { ZIO.fromAutoCloseable(ZIO.attemptBlocking(new FileInputStream(file))) } to safely open and manage file streams
  - computeDigest no longer owns the InputStream lifecycle — callers manage it, avoiding double-close
  - FileNotFoundException from opening is now caught as typed BagItError.IoError, not a defect
  - 92 tests pass in ~490ms
---

## 2026-02-13 17:42 - US-022
- What was implemented: Added 3 tests for FileInputStream resource leak fix: 100+ file validation without FD exhaustion, payload file deletion returns typed error, tag file deletion returns typed error
- Files changed:
  - modules/bagit/src/test/scala/org/knora/bagit/internal/BagValidatorSpec.scala (updated 60-file test to 120 files, added 2 new tests)
- **Learnings for future iterations:**
  - The existing "deleted payload file" and "deleted bag-info.txt" tests already cover similar ground — US-022 tests specifically name "between parsing and checksum verification" to emphasize typed errors vs defects
  - BagValidator.validateCollectingErrors returns UIO[List[BagItError]] — it never throws defects, all errors are typed
  - 94 tests pass in ~668ms
---

## Codebase Patterns
- Value classes extend StringValue and use StringValueCompanion[T] companion objects
- Query builders extend QueryBuilderHelper and use string interpolation for complex SPARQL
- Use zeroOrMore() for property paths like previousValue*
- KnoraBase vocabulary constants are in org.knora.webapi.slice.common.repo.rdf.Vocabulary.KnoraBase
- Unit tests for query builders compare full SPARQL strings using stripMargin
- Integration tests require Docker Desktop for testcontainers
- New sbt modules: follow testkit pattern - use buildSettings, customScalacOptions, HeaderPlugin, publish/skip := true
- License header: `/* Copyright © 2021 - {year} Swiss National Data and Service Center ... */` auto-managed by HeaderPlugin
- Dependencies: add to project/Dependencies.scala, use existing version vals (ZioVersion, ZioNioVersion)
- BagIt module: public API is `org.knora.bagit.BagIt` (create, readAndValidateZip, validateZipCollectingErrors)
- Strict scalac flags: remove unused imports or variables immediately — they cause compile errors
- ManifestPathEncoding: only encode LF/CR/% per RFC 8493 Section 2.1.3; decode before path validation for security
- BagInfo.additionalFields is List[(String, String)] — preserves ordering and allows duplicate keys per RFC 8493 Section 2.2.2
- Resource management: wrap scala.io.Source in try/finally; open FileInputStreams inside ZIO effects at the call site (BagValidator), computeDigest no longer owns stream lifecycle
- Null-safe file listing: use `Option(dir.listFiles()).map(_.toList).getOrElse(Nil)` — listFiles() returns null on I/O errors
- Nested stream safety: open FileInputStream and ZipInputStream as separate ZIO.fromAutoCloseable resources so each has its own scope
- Zip bomb protection: ExtractionLimits (maxTotalBytes, maxEntryCount, maxSingleEntryBytes) enforced in extractZip via Ref[Long] for byte tracking; default params keep public API unchanged
- Stack-safe directory walks: use `scala.collection.mutable.ArrayDeque` with `append`/`removeLast` (not Java's addLast/pollLast); push dirs in reverse sorted order for depth-first files-before-dirs traversal

## 2026-02-13 17:44 - US-023
- What was implemented: Fixed nested stream construction in BagReader.extractZip — FileInputStream and ZipInputStream are now opened as two separately managed resources using chained ZIO.fromAutoCloseable calls
- Files changed:
  - modules/bagit/src/main/scala/org/knora/bagit/internal/BagReader.scala (extractZip: split nested stream construction into two separate ZIO.fromAutoCloseable calls)
- **Learnings for future iterations:**
  - Pattern for safe nested stream construction: open outer stream with ZIO.fromAutoCloseable first, then wrap with inner stream in a second ZIO.fromAutoCloseable — each gets its own scope
  - `new ZipInputStream(new FileInputStream(...))` in a single fromAutoCloseable only registers the ZipInputStream for auto-close; if the ZipInputStream constructor fails, the FileInputStream leaks
  - The fix is minimal: replace the single-line fromAutoCloseable with a for-comprehension that opens each stream separately
  - 94 tests pass in ~703ms
---

## 2026-02-13 17:49 - US-024
- What was implemented: Added zip bomb protection to BagReader.extractZip — enforces maxTotalBytes, maxEntryCount, and maxSingleEntryBytes limits during extraction
- Files changed:
  - modules/bagit/src/main/scala/org/knora/bagit/ExtractionLimits.scala (new — case class with default limits: 10GB total, 100K entries, 5GB per entry)
  - modules/bagit/src/main/scala/org/knora/bagit/BagItError.scala (added ExtractionLimitExceeded error variant)
  - modules/bagit/src/main/scala/org/knora/bagit/internal/BagReader.scala (extractZip accepts ExtractionLimits param, tracks bytes via Ref[Long], counts entries)
- **Learnings for future iterations:**
  - Use Ref[Long] to track total bytes across entries — it's shared between copyToFile calls via processEntries
  - The writeLoop pattern: allocate buffer per iteration (not shared), read from ZipInputStream, check single-entry limit, update total via Ref, check total limit, then write to FileOutputStream
  - Entry count check happens before extraction (fail-fast), byte checks happen during write
  - Default parameter on readFromZip means BagIt public API (readAndValidateZip, validateZipCollectingErrors) needs no changes
  - ZIO.fromAutoCloseable for FileOutputStream needs its own .mapError to avoid leaking Throwable into the error channel
  - 94 tests pass in ~681ms
---

## 2026-02-13 17:52 - US-025
- What was implemented: Added 4 tests for zip bomb protection in BagReaderSpec: single entry exceeding maxSingleEntryBytes, entry count exceeding maxEntryCount, total decompressed size exceeding maxTotalBytes, and normal bag within default limits
- Files changed:
  - modules/bagit/src/test/scala/org/knora/bagit/internal/BagReaderSpec.scala (4 new tests, added ExtractionLimits import)
- **Learnings for future iterations:**
  - Use small limits (1KB, 5 entries, 2KB) for fast and deterministic tests instead of creating actual large files
  - createMinimalZip helper in BagReaderSpec accepts Map[String, String] — use string repetition ("x" * 2000) for creating entries of specific sizes
  - For entry count tests, include explicit "data/" directory entries plus individual files and tag files to exceed the count limit
  - BagReader.readFromZip accepts ExtractionLimits as a second parameter with defaults, so existing callers are unaffected
  - 98 tests pass in ~748ms
---

## 2026-02-13 17:55 - US-026
- What was implemented: Added size limits on in-memory file reads in BagReader — readContent and readLines now check file size before reading, rejecting files larger than 10 MB with FileTooLarge error
- Files changed:
  - modules/bagit/src/main/scala/org/knora/bagit/BagItError.scala (added FileTooLarge error variant with fileName and size)
  - modules/bagit/src/main/scala/org/knora/bagit/internal/BagReader.scala (added MaxTagFileSize constant, checkFileSize helper, size checks before readContent and readLines)
- **Learnings for future iterations:**
  - Use java.io.File.length() to check file size before loading into memory — it's a cheap OS-level stat call
  - The checkFileSize helper checks MaxTagFileSize (10 MB default) and returns FileTooLarge error with file name and size
  - readContent and readLines both call checkFileSize first via `*>` composition — minimal code change
  - The check is private to BagReader; no public API change needed since readContent/readLines are already private
  - 98 tests pass in ~696ms
---

## 2026-02-13 18:00 - US-027
- What was implemented: Added 3 tests for in-memory file size limits: manifest file exceeding maxTagFileSize rejected with FileTooLarge, bag-info.txt exceeding maxTagFileSize rejected with FileTooLarge, normal bag with default limit reads successfully
- Files changed:
  - modules/bagit/src/main/scala/org/knora/bagit/internal/BagReader.scala (made MaxTagFileSize configurable via maxTagFileSize parameter on readFromZip, threaded through to all private read methods)
  - modules/bagit/src/test/scala/org/knora/bagit/internal/BagReaderSpec.scala (3 new tests)
- **Learnings for future iterations:**
  - To test file size limits with small values, make the limit a parameter with a default value (like ExtractionLimits pattern) — the hard-coded MaxTagFileSize constant becomes the default
  - Thread limit parameter through: readFromZip → parseBag → parseBagitTxt/parseManifests/parseBagInfo → readContent/readLines → checkFileSize
  - Use createMinimalZip helper with large strings (e.g., "A" * 200) to create tag files exceeding the small test limit (100 bytes)
  - BagCreatorSpec.scala had formatting-only changes from scalafmt — no syntactic changes, safe to include in commit
  - 101 tests pass in ~885ms
---

## 2026-02-13 18:04 - US-028
- What was implemented: Replaced plain recursion in walkFiles/walkDirectory with iterative approach using explicit work stack (scala.collection.mutable.ArrayDeque) in all three locations: BagReader.walkFiles, BagCreator.walkDirectory, BagValidator.walkFiles
- Files changed:
  - modules/bagit/src/main/scala/org/knora/bagit/internal/BagReader.scala (walkFiles: iterative with ArrayDeque)
  - modules/bagit/src/main/scala/org/knora/bagit/internal/BagCreator.scala (walkDirectory: iterative with ArrayDeque)
  - modules/bagit/src/main/scala/org/knora/bagit/internal/BagValidator.scala (walkFiles: iterative with ArrayDeque)
- **Learnings for future iterations:**
  - Scala's `scala.collection.mutable.ArrayDeque` uses `append` and `removeLast` (not `addLast`/`pollLast` like Java's ArrayDeque)
  - To preserve depth-first files-before-dirs ordering: push dirs in reverse sorted order so first alphabetically is popped last (processed next)
  - Pattern: use `removeLast()` to pop from the stack end (LIFO) for depth-first traversal
  - All 101 existing tests pass unchanged — the iterative implementation is behaviorally identical
  - 101 tests pass in ~797ms
---
